{% extends "base.html" %}

{% block title %}Step 4: Monitor Execution{% endblock %}

{% block stepper %}
{% set current_step = 4 %}
{% include 'components/stepper.html' %}
{% endblock %}

{% block content %}
<div class="step-content">
    <h2>Step 4: Monitor Execution</h2>
    <p>Real-time monitoring of your Databricks job execution.</p>

    <div class="monitor-section">
        <div class="job-header">
            <h3>Job Run: <span id="runId">{{ run_id }}</span></h3>
            <div class="job-controls">
                <button class="btn btn-small btn-secondary" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                    Auto-refresh: <span id="autoRefreshStatus">ON</span>
                </button>
                <button class="btn btn-small btn-danger" onclick="cancelJob()">Cancel Job</button>
            </div>
        </div>

        <div class="overall-status">
            <div class="status-card">
                <h4>Overall Status</h4>
                <div id="overallStatus" class="status-badge status-pending">PENDING</div>
                <div class="status-details">
                    <p><strong>Duration:</strong> <span id="duration">0s</span></p>
                    <p><strong>Progress:</strong></p>
                    <div class="progress-bar">
                        <div id="overallProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tasks-section">
            <h3>Task Status</h3>
            <div id="tasksContainer" class="tasks-grid">
                <p class="loading-message">Loading task status...</p>
            </div>
        </div>
    </div>

    <div class="completion-actions" id="completionActions" style="display: none;">
        <button class="btn btn-secondary" onclick="window.location.href='/'">Back to Home</button>
        <button class="btn btn-primary" onclick="window.location.href='/step1'">Start New Conversion</button>
    </div>
</div>

<!-- Task Logs Modal -->
<div id="logsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Task Logs: <span id="modalTaskName"></span></h3>
            <span class="close" onclick="closeLogsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <pre id="logsContent" class="logs-content">Loading logs...</pre>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeLogsModal()">Close</button>
        </div>
    </div>
</div>

<script>
const runId = '{{ run_id }}';
let pollInterval = null;
let autoRefresh = true;

// Start polling immediately
window.addEventListener('load', () => {
    pollRunStatus();
    pollInterval = setInterval(pollRunStatus, 5000);
});

async function pollRunStatus() {
    if (!autoRefresh) return;

    try {
        const response = await fetch(`/api/run/${runId}/status`);
        const data = await response.json();

        if (!data.success) {
            console.error('Error fetching run status:', data.error);
            return;
        }

        updateJobStatus(data.status);
    } catch (error) {
        console.error('Error polling run status:', error);
    }
}

function updateJobStatus(status) {
    // Update overall status
    const statusBadge = document.getElementById('overallStatus');
    statusBadge.textContent = status.state;
    statusBadge.className = `status-badge status-${status.state.toLowerCase()}`;

    // Update duration
    document.getElementById('duration').textContent = formatDuration(status.duration_seconds);

    // Update tasks
    updateTasks(status.tasks);

    // Calculate and update progress
    const progress = calculateProgress(status.tasks);
    document.getElementById('overallProgress').style.width = progress + '%';

    // Check if job is complete
    if (status.state === 'SUCCESS' || status.state === 'FAILED' || status.state === 'CANCELLED') {
        clearInterval(pollInterval);
        document.getElementById('completionActions').style.display = 'block';
    }
}

function updateTasks(tasks) {
    const container = document.getElementById('tasksContainer');

    if (!tasks || tasks.length === 0) {
        container.innerHTML = '<p class="info-message">No tasks found</p>';
        return;
    }

    let html = '';
    tasks.forEach(task => {
        const icon = getStatusIcon(task.state);
        const statusClass = task.state.toLowerCase();

        html += `
            <div class="task-card">
                <div class="task-header">
                    <span class="task-icon">${icon}</span>
                    <h4>${task.task_key}</h4>
                </div>
                <div class="task-body">
                    <div class="status-badge status-${statusClass}">${task.state}</div>
                    ${task.duration_seconds !== null ? `<p>Duration: ${formatDuration(task.duration_seconds)}</p>` : ''}
                    ${task.error_message ? `<p class="error-text">${task.error_message}</p>` : ''}
                </div>
                <div class="task-footer">
                    <button class="btn btn-small btn-secondary" onclick="viewLogs('${task.task_key}')">View Logs</button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getStatusIcon(state) {
    const icons = {
        'PENDING': 'â³',
        'RUNNING': 'ðŸ”„',
        'SUCCESS': 'âœ…',
        'FAILED': 'âŒ',
        'TIMEOUT': 'âš ï¸',
        'CANCELLED': 'ðŸš«'
    };
    return icons[state] || 'â“';
}

function calculateProgress(tasks) {
    if (!tasks || tasks.length === 0) return 0;

    const completed = tasks.filter(t => ['SUCCESS', 'FAILED', 'CANCELLED'].includes(t.state)).length;
    return Math.round((completed / tasks.length) * 100);
}

function formatDuration(seconds) {
    if (!seconds || seconds === 0) return '0s';

    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
}

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    document.getElementById('autoRefreshStatus').textContent = autoRefresh ? 'ON' : 'OFF';

    if (autoRefresh && !pollInterval) {
        pollRunStatus();
        pollInterval = setInterval(pollRunStatus, 5000);
    } else if (!autoRefresh && pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

async function viewLogs(taskKey) {
    document.getElementById('modalTaskName').textContent = taskKey;
    document.getElementById('logsContent').textContent = 'Loading logs...';
    document.getElementById('logsModal').style.display = 'block';

    try {
        const response = await fetch(`/api/run/${runId}/task/${taskKey}/logs`);
        const data = await response.json();

        if (data.success) {
            document.getElementById('logsContent').textContent = data.logs;
        } else {
            document.getElementById('logsContent').textContent = `Error: ${data.error}`;
        }
    } catch (error) {
        document.getElementById('logsContent').textContent = `Error: ${error.message}`;
    }
}

function closeLogsModal() {
    document.getElementById('logsModal').style.display = 'none';
}

async function cancelJob() {
    if (!confirm('Are you sure you want to cancel this job?')) {
        return;
    }

    try {
        const response = await fetch(`/api/run/${runId}/cancel`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            alert('Job cancelled successfully');
            pollRunStatus();
        } else {
            alert(`Error: ${data.error || data.message}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('logsModal');
    if (event.target === modal) {
        closeLogsModal();
    }
}
</script>
{% endblock %}
