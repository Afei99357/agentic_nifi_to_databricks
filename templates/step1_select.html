{% extends "base.html" %}

{% block title %}Step 1: Select NiFi Flow{% endblock %}

{% block stepper %}
{% set current_step = 1 %}
{% include 'components/stepper.html' %}
{% endblock %}

{% block content %}
<div class="step-content">
    <h2>Step 1: Select NiFi Flow</h2>
    <p>Choose a NiFi XML file from Unity Catalog to convert.</p>

    <div class="file-browser-section">
        <div class="volume-selector">
            <label for="catalog">Catalog:</label>
            <input type="text" id="catalog" value="main" placeholder="Enter catalog name">

            <label for="schema">Schema:</label>
            <input type="text" id="schema" value="default" placeholder="Enter schema name">

            <button class="btn btn-secondary" onclick="loadVolumes()">Load Volumes</button>
        </div>

        <div class="volume-list" id="volumeList">
            <p class="loading-message">Enter catalog and schema, then click "Load Volumes"</p>
        </div>

        <div class="file-list" id="fileList" style="display: none;">
            <h3>Files in <span id="currentPath"></span></h3>
            <div id="filesContainer"></div>
        </div>

        <div class="file-actions" id="fileActions" style="display: none;">
            <button class="btn btn-secondary" onclick="previewFile()">Preview XML</button>
            <button class="btn btn-primary" onclick="startConversion()">Convert to Notebooks</button>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>XML Preview</h3>
            <span class="close" onclick="closePreviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="validationMessage"></div>
            <pre id="previewContent"></pre>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
        </div>
    </div>
</div>

<script>
let selectedFilePath = null;

async function loadVolumes() {
    const catalog = document.getElementById('catalog').value;
    const schema = document.getElementById('schema').value;
    const volumeList = document.getElementById('volumeList');

    volumeList.innerHTML = '<p class="loading-message">Loading volumes...</p>';

    try {
        const response = await fetch(`/api/volumes?catalog=${catalog}&schema=${schema}`);
        const data = await response.json();

        if (!data.success) {
            volumeList.innerHTML = `<p class="error-message">Error: ${data.error}</p>`;
            return;
        }

        if (data.volumes.length === 0) {
            volumeList.innerHTML = '<p class="info-message">No volumes found</p>';
            return;
        }

        let html = '<h3>Available Volumes</h3><ul class="volume-items">';
        data.volumes.forEach(volume => {
            html += `<li class="volume-item" onclick="loadFiles('${volume.full_path}')">
                <span class="volume-icon">üìÇ</span>
                <span class="volume-name">${volume.name}</span>
            </li>`;
        });
        html += '</ul>';
        volumeList.innerHTML = html;
    } catch (error) {
        volumeList.innerHTML = `<p class="error-message">Error loading volumes: ${error.message}</p>`;
    }
}

async function loadFiles(path) {
    const fileList = document.getElementById('fileList');
    const filesContainer = document.getElementById('filesContainer');

    fileList.style.display = 'block';
    document.getElementById('currentPath').textContent = path;
    filesContainer.innerHTML = '<p class="loading-message">Loading files...</p>';

    try {
        const response = await fetch(`/api/files?path=${encodeURIComponent(path)}&filter_xml=true`);
        const data = await response.json();

        if (!data.success) {
            filesContainer.innerHTML = `<p class="error-message">Error: ${data.error}</p>`;
            return;
        }

        if (data.files.length === 0) {
            filesContainer.innerHTML = '<p class="info-message">No XML files found</p>';
            return;
        }

        let html = '<ul class="file-items">';
        data.files.forEach(file => {
            const icon = file.is_directory ? 'üìÅ' : 'üìÑ';
            html += `<li class="file-item" onclick="selectFile('${file.path}', '${file.name}', ${file.is_directory})">
                <input type="radio" name="selected_file" value="${file.path}" ${!file.is_directory ? '' : 'disabled'}>
                <span class="file-icon">${icon}</span>
                <span class="file-name">${file.name}</span>
                <span class="file-size">${file.size_mb} MB</span>
            </li>`;
        });
        html += '</ul>';
        filesContainer.innerHTML = html;
    } catch (error) {
        filesContainer.innerHTML = `<p class="error-message">Error loading files: ${error.message}</p>`;
    }
}

function selectFile(path, name, isDirectory) {
    if (isDirectory) {
        loadFiles(path);
        return;
    }

    selectedFilePath = path;

    // Update radio button selection
    const radioButtons = document.querySelectorAll('input[name="selected_file"]');
    radioButtons.forEach(radio => {
        if (radio.value === path) {
            radio.checked = true;
        }
    });

    // Highlight selected file
    const fileItems = document.querySelectorAll('.file-item');
    fileItems.forEach(item => item.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    document.getElementById('fileActions').style.display = 'block';
}

async function previewFile() {
    if (!selectedFilePath) {
        alert('Please select a file first');
        return;
    }

    const modal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    const validationMessage = document.getElementById('validationMessage');

    previewContent.textContent = 'Loading preview...';
    validationMessage.innerHTML = '';
    modal.style.display = 'block';

    try {
        const response = await fetch('/api/file/preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_path: selectedFilePath})
        });

        const data = await response.json();

        if (!data.success) {
            previewContent.textContent = `Error: ${data.error}`;
            return;
        }

        previewContent.textContent = data.preview;

        if (data.is_valid) {
            validationMessage.innerHTML = '<div class="success-message">‚úì Valid NiFi XML file</div>';
        } else {
            validationMessage.innerHTML = `<div class="error-message">‚úó ${data.validation_message}</div>`;
        }
    } catch (error) {
        previewContent.textContent = `Error: ${error.message}`;
    }
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

async function startConversion() {
    if (!selectedFilePath) {
        alert('Please select a file first');
        return;
    }

    if (!confirm('Start conversion process?')) {
        return;
    }

    try {
        const response = await fetch('/api/convert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_path: selectedFilePath})
        });

        const data = await response.json();

        if (!data.success) {
            alert(`Error: ${data.error}`);
            return;
        }

        // Redirect to step 2
        window.location.href = `/step2/${data.job.job_id}`;
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('previewModal');
    if (event.target === modal) {
        closePreviewModal();
    }
}
</script>
{% endblock %}
