{% extends "base.html" %}

{% block title %}Step 3: Deploy & Run{% endblock %}

{% block stepper %}
{% set current_step = 3 %}
{% include 'components/stepper.html' %}
{% endblock %}

{% block content %}
<div class="step-content">
    <h2>Step 3: Deploy & Run</h2>
    <p>Configure and deploy your notebooks as a Databricks job with parallel execution.</p>

    <div class="deploy-section">
        <div class="config-form">
            <h3>Job Configuration</h3>

            <div class="form-group">
                <label for="jobName">Job Name:</label>
                <input type="text" id="jobName" placeholder="nifi_conversion_job" value="nifi_conversion_{{ job_id }}">
            </div>

            <div class="form-group">
                <label for="clusterType">Cluster Type:</label>
                <select id="clusterType">
                    <option value="new">New Cluster (Default)</option>
                    <option value="existing" disabled>Existing Cluster (Coming Soon)</option>
                </select>
            </div>

            <div class="info-box">
                <h4>Execution Plan</h4>
                <p>All notebooks will execute in parallel as independent tasks.</p>
                <ul>
                    <li>One Databricks job will be created</li>
                    <li>Each notebook runs as a separate task</li>
                    <li>No dependencies between tasks</li>
                    <li>Tasks run simultaneously</li>
                </ul>
            </div>
        </div>

        <div class="deployment-diagram">
            <h3>Parallel Execution Diagram</h3>
            <div class="diagram">
                <div class="diagram-row">
                    <div class="diagram-node job-node">Databricks Job</div>
                </div>
                <div class="diagram-row">
                    <div class="diagram-connector-group">
                        <div class="diagram-connector"></div>
                        <div class="diagram-connector"></div>
                        <div class="diagram-connector"></div>
                    </div>
                </div>
                <div class="diagram-row tasks-row">
                    <div class="diagram-node task-node">Task 1</div>
                    <div class="diagram-node task-node">Task 2</div>
                    <div class="diagram-node task-node">Task N...</div>
                </div>
                <div class="diagram-row">
                    <div class="diagram-label">All tasks run in parallel</div>
                </div>
            </div>
        </div>

        <div class="deploy-actions">
            <button class="btn btn-secondary" onclick="window.location.href='/step2/{{ job_id }}'">Back to Review</button>
            <button class="btn btn-secondary" onclick="createJobOnly()">Create Job Only</button>
            <button class="btn btn-primary" onclick="createAndRun()">Create & Run Now</button>
        </div>
    </div>

    <div id="deploymentProgress" class="deployment-progress" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="deploymentStatus">Creating job...</p>
    </div>
</div>

<script>
const jobId = '{{ job_id }}';

async function createAndRun() {
    const jobName = document.getElementById('jobName').value || `nifi_conversion_${jobId}`;

    if (!confirm('Create job and run immediately?')) {
        return;
    }

    showDeploymentProgress('Creating and starting job...');

    try {
        const response = await fetch(`/api/job/${jobId}/deploy-and-run`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                job_name: jobName,
                run_immediately: true
            })
        });

        const data = await response.json();

        if (!data.success) {
            alert(`Error: ${data.error}`);
            hideDeploymentProgress();
            return;
        }

        // Redirect to monitoring page
        window.location.href = `/step3b/${data.run_id}`;
    } catch (error) {
        alert(`Error: ${error.message}`);
        hideDeploymentProgress();
    }
}

async function createJobOnly() {
    const jobName = document.getElementById('jobName').value || `nifi_conversion_${jobId}`;

    if (!confirm('Create job without running?')) {
        return;
    }

    showDeploymentProgress('Creating job...');

    try {
        const response = await fetch(`/api/job/${jobId}/deploy-and-run`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                job_name: jobName,
                run_immediately: false
            })
        });

        const data = await response.json();

        if (!data.success) {
            alert(`Error: ${data.error}`);
            hideDeploymentProgress();
            return;
        }

        alert(`Job created successfully! Job ID: ${data.job_id}`);
        hideDeploymentProgress();
    } catch (error) {
        alert(`Error: ${error.message}`);
        hideDeploymentProgress();
    }
}

function showDeploymentProgress(message) {
    document.getElementById('deploymentStatus').textContent = message;
    document.getElementById('deploymentProgress').style.display = 'block';
}

function hideDeploymentProgress() {
    document.getElementById('deploymentProgress').style.display = 'none';
}
</script>
{% endblock %}
