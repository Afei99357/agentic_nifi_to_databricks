{% extends "base.html" %}

{% block title %}Step 2: Review Conversion{% endblock %}

{% block stepper %}
{% set current_step = 2 %}
{% include 'components/stepper.html' %}
{% endblock %}

{% block content %}
<div class="step-content">
    <h2>Step 2: Review Conversion</h2>
    <p>AI agent is converting your NiFi flow to Databricks notebooks.</p>

    <div id="conversionProgress" class="progress-section">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <p id="statusMessage" class="status-message">Initializing conversion...</p>
        <p id="progressPercent" class="progress-percent">0%</p>
    </div>

    <div id="notebooksSection" class="notebooks-section" style="display: none;">
        <h3>Generated Notebooks</h3>
        <div id="notebooksList"></div>

        <div class="notebook-actions">
            <button class="btn btn-secondary" onclick="downloadAll()">Download All as ZIP</button>
            <button class="btn btn-primary" onclick="proceedToDeploy()">Proceed to Deploy</button>
        </div>
    </div>

    <div id="errorSection" class="error-section" style="display: none;">
        <div class="error-message">
            <h3>Conversion Failed</h3>
            <p id="errorMessage"></p>
            <button class="btn btn-secondary" onclick="window.location.href='/step1'">Back to Step 1</button>
        </div>
    </div>
</div>

<!-- Notebook Preview Modal -->
<div id="notebookModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modalNotebookName">Notebook Preview</h3>
            <span class="close" onclick="closeNotebookModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="notebookPreview" class="notebook-preview"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNotebookModal()">Close</button>
            <button class="btn btn-primary" onclick="downloadCurrentNotebook()">Download</button>
        </div>
    </div>
</div>

<script>
const jobId = '{{ job_id }}';
let pollInterval = null;
let notebooks = [];
let currentNotebook = null;

// Start polling immediately
window.addEventListener('load', () => {
    pollJobStatus();
    pollInterval = setInterval(pollJobStatus, 2500);
});

async function pollJobStatus() {
    try {
        const response = await fetch(`/api/job/${jobId}/status`);
        const data = await response.json();

        if (!data.success) {
            handleError(data.error);
            return;
        }

        const job = data.job;
        updateProgress(job.progress_percentage, job.status_message);

        if (job.status === 'completed') {
            clearInterval(pollInterval);
            await loadNotebooks();
        } else if (job.status === 'failed') {
            clearInterval(pollInterval);
            handleError(job.error_message || 'Conversion failed');
        }
    } catch (error) {
        console.error('Error polling job status:', error);
    }
}

function updateProgress(percentage, message) {
    document.getElementById('progressFill').style.width = percentage + '%';
    document.getElementById('progressPercent').textContent = percentage + '%';
    document.getElementById('statusMessage').textContent = message;
}

async function loadNotebooks() {
    try {
        const response = await fetch(`/api/job/${jobId}/notebooks`);
        const data = await response.json();

        if (!data.success) {
            handleError(data.error);
            return;
        }

        notebooks = data.notebooks;
        displayNotebooks(notebooks);
    } catch (error) {
        handleError(error.message);
    }
}

function displayNotebooks(notebooks) {
    document.getElementById('conversionProgress').style.display = 'none';
    document.getElementById('notebooksSection').style.display = 'block';

    const notebooksList = document.getElementById('notebooksList');
    let html = '<div class="notebooks-grid">';

    notebooks.forEach((notebook, index) => {
        html += `
            <div class="notebook-card">
                <div class="notebook-header">
                    <span class="notebook-icon">ðŸ““</span>
                    <h4>${notebook.notebook_name}</h4>
                </div>
                <div class="notebook-body">
                    <p class="notebook-flow">Flow: ${notebook.flow_id}</p>
                </div>
                <div class="notebook-footer">
                    <button class="btn btn-small btn-secondary" onclick="previewNotebook(${index})">Preview</button>
                    <button class="btn btn-small btn-secondary" onclick="downloadNotebook('${notebook.notebook_name}')">Download</button>
                </div>
            </div>
        `;
    });

    html += '</div>';
    notebooksList.innerHTML = html;
}

function previewNotebook(index) {
    currentNotebook = notebooks[index];
    document.getElementById('modalNotebookName').textContent = currentNotebook.notebook_name;
    document.getElementById('notebookPreview').innerHTML = currentNotebook.preview_html || `<pre>${currentNotebook.content}</pre>`;
    document.getElementById('notebookModal').style.display = 'block';
}

function closeNotebookModal() {
    document.getElementById('notebookModal').style.display = 'none';
}

function downloadNotebook(notebookName) {
    window.location.href = `/api/job/${jobId}/download/${notebookName}`;
}

function downloadCurrentNotebook() {
    if (currentNotebook) {
        downloadNotebook(currentNotebook.notebook_name);
    }
}

function downloadAll() {
    window.location.href = `/api/job/${jobId}/download-all`;
}

function proceedToDeploy() {
    window.location.href = `/step3/${jobId}`;
}

function handleError(message) {
    document.getElementById('conversionProgress').style.display = 'none';
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('notebookModal');
    if (event.target === modal) {
        closeNotebookModal();
    }
}
</script>
{% endblock %}
