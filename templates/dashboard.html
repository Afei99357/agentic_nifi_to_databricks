{% extends "base.html" %}

{% block title %}NiFi Flow Dashboard{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    padding: 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.dashboard-header h2 {
    margin: 0;
    color: #333;
}

.dashboard-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

#searchInput {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 300px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.flow-table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.flow-table {
    width: 100%;
    border-collapse: collapse;
}

.flow-table th,
.flow-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.flow-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
}

.flow-table tbody tr:hover {
    background-color: #f8f9fa;
}

.flow-row.converting {
    background-color: #e3f2fd;
}

.flow-row a {
    color: #007bff;
    text-decoration: none;
}

.flow-row a:hover {
    text-decoration: underline;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
}

.badge-gray { background-color: #6c757d; color: white; }
.badge-blue { background-color: #007bff; color: white; }
.badge-green { background-color: #28a745; color: white; }
.badge-red { background-color: #dc3545; color: white; }

.progress-bar-container {
    position: relative;
    width: 120px;
    height: 24px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: #495057;
}

.loading-message,
.info-message,
.error-message {
    text-align: center;
    padding: 40px;
    font-size: 14px;
    color: #6c757d;
}

.error-message {
    color: #dc3545;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    max-width: 800px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 20px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

.modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.flow-details {
    line-height: 1.6;
}

.flow-details h4 {
    margin-top: 20px;
    margin-bottom: 10px;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 5px;
}

.flow-details p {
    margin: 8px 0;
}

.flow-details strong {
    color: #495057;
    display: inline-block;
    min-width: 150px;
}

.flow-details ul {
    list-style: none;
    padding-left: 0;
}

.flow-details li {
    padding: 5px 0;
    border-bottom: 1px solid #e9ecef;
}

.stats-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    flex: 1;
    min-width: 150px;
}

.stat-card h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    opacity: 0.9;
}

.stat-card .stat-value {
    font-size: 28px;
    font-weight: bold;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.history-table th,
.history-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.history-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.history-table tr:hover {
    background-color: #f8f9fa;
}

.history-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #e9ecef;
}

.btn-history {
    margin-top: 10px;
    background-color: #6c757d;
    color: white;
}

.btn-history:hover {
    background-color: #545b62;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>NiFi Flow Conversions</h2>
        <div class="dashboard-actions">
            <input type="text" id="searchInput" placeholder="Search flows..." onkeyup="filterFlows()">
            <button class="btn btn-primary" onclick="startSelectedFlows()" id="bulkStartBtn" disabled>
                Launch Selected Conversions
            </button>
        </div>
    </div>

    <div class="stats-container" id="statsContainer">
        <!-- Stats will be populated by JavaScript -->
    </div>

    <div class="flow-table-container">
        <table class="flow-table" id="flowTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>Flow Name</th>
                    <th>Server</th>
                    <th>Owner</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Iterations</th>
                    <th>Validation %</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="flowTableBody">
                <tr><td colspan="10" class="loading-message">Loading flows...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Flow Details Modal -->
<div id="flowDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalFlowName">Flow Details</h3>
            <span class="close" onclick="closeFlowDetails()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="flowDetailsContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let flows = [];
let selectedFlowIds = new Set();
let refreshInterval = null;

// Load flows on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFlows();
    startAutoRefresh();
});

async function loadFlows() {
    try {
        const response = await fetch('/api/flows');
        const data = await response.json();

        if (data.success) {
            flows = data.flows;
            renderFlowTable();
            updateStats();
        } else {
            showError('Failed to load flows: ' + data.error);
        }
    } catch (error) {
        showError('Error loading flows: ' + error.message);
    }
}

function renderFlowTable() {
    const tbody = document.getElementById('flowTableBody');

    if (flows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="info-message">No flows found</td></tr>';
        return;
    }

    let html = '';
    flows.forEach(flow => {
        const statusBadge = getStatusBadge(flow.status);
        const progressBar = getProgressBar(flow.progress_percentage);
        const isConverting = flow.status === 'CONVERTING';
        const canStart = flow.status === 'NOT_STARTED' || flow.status === 'NEEDS_ATTENTION';

        html += `
            <tr class="flow-row ${isConverting ? 'converting' : ''}" data-flow-id="${flow.flow_name}">
                <td><input type="checkbox" class="flow-checkbox" value="${flow.flow_name}"
                    ${canStart ? '' : 'disabled'} onchange="updateBulkButton()"></td>
                <td><a href="#" onclick="showFlowDetails('${flow.flow_name}'); return false;">${escapeHtml(flow.flow_name)}</a></td>
                <td>${escapeHtml(flow.server || 'N/A')}</td>
                <td>${escapeHtml(flow.owner || 'N/A')}</td>
                <td>${statusBadge}</td>
                <td>${progressBar}</td>
                <td>${flow.iterations || 0}</td>
                <td>${flow.validation_percentage || 0}%</td>
                <td>${formatTimestamp(flow.last_updated)}</td>
                <td>
                    ${canStart ?
                        `<button class="btn btn-sm btn-primary" onclick="startFlow('${flow.flow_name}')">Start</button>` :
                        isConverting ?
                        `<button class="btn btn-sm btn-secondary" onclick="stopFlow('${flow.flow_name}')">Stop</button>` :
                        `<button class="btn btn-sm btn-secondary" onclick="showFlowDetails('${flow.flow_name}')">View</button>`
                    }
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

function updateStats() {
    const stats = {
        total: flows.length,
        not_started: flows.filter(f => f.status === 'NOT_STARTED').length,
        converting: flows.filter(f => f.status === 'CONVERTING').length,
        done: flows.filter(f => f.status === 'DONE').length,
        needs_attention: flows.filter(f => f.status === 'NEEDS_ATTENTION').length
    };

    const statsContainer = document.getElementById('statsContainer');
    statsContainer.innerHTML = `
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <h4>Total Flows</h4>
            <div class="stat-value">${stats.total}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h4>Not Started</h4>
            <div class="stat-value">${stats.not_started}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h4>Converting</h4>
            <div class="stat-value">${stats.converting}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <h4>Completed</h4>
            <div class="stat-value">${stats.done}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h4>Needs Attention</h4>
            <div class="stat-value">${stats.needs_attention}</div>
        </div>
    `;
}

function getStatusBadge(status) {
    const badges = {
        'NOT_STARTED': '<span class="badge badge-gray">Not Started</span>',
        'CONVERTING': '<span class="badge badge-blue">Converting</span>',
        'DONE': '<span class="badge badge-green">Done</span>',
        'NEEDS_ATTENTION': '<span class="badge badge-red">Needs Attention</span>'
    };
    return badges[status] || '<span class="badge badge-gray">Unknown</span>';
}

function getProgressBar(percentage) {
    return `
        <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${percentage}%"></div>
            <span class="progress-text">${percentage}%</span>
        </div>
    `;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleString();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function startFlow(flowId) {
    try {
        const response = await fetch(`/api/flows/${flowId}/start`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showSuccess('Conversion started');
            loadFlows();
        } else {
            showError('Failed to start: ' + data.error);
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

async function stopFlow(flowId) {
    if (!confirm('Stop this conversion?')) return;

    try {
        const response = await fetch(`/api/flows/${flowId}/stop`, { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            showSuccess('Conversion stopped');
            loadFlows();
        } else {
            showError('Failed to stop: ' + data.error);
        }
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

async function startSelectedFlows() {
    const flowIds = Array.from(selectedFlowIds);

    if (flowIds.length === 0) {
        alert('Please select flows to convert');
        return;
    }

    if (!confirm(`Start ${flowIds.length} conversion(s)?`)) return;

    try {
        const response = await fetch('/api/flows/bulk-start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({flow_names: flowIds})
        });

        const data = await response.json();
        showSuccess(`Started ${data.started} conversion(s)`);
        selectedFlowIds.clear();
        document.getElementById('selectAll').checked = false;
        loadFlows();
    } catch (error) {
        showError('Error: ' + error.message);
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    document.querySelectorAll('.flow-checkbox:not([disabled])').forEach(cb => {
        cb.checked = selectAll;
        if (selectAll) {
            selectedFlowIds.add(cb.value);
        } else {
            selectedFlowIds.delete(cb.value);
        }
    });
    updateBulkButton();
}

function updateBulkButton() {
    selectedFlowIds.clear();
    document.querySelectorAll('.flow-checkbox:checked').forEach(cb => {
        selectedFlowIds.add(cb.value);
    });
    document.getElementById('bulkStartBtn').disabled = selectedFlowIds.size === 0;
}

async function showFlowDetails(flowId) {
    const modal = document.getElementById('flowDetailsModal');
    const content = document.getElementById('flowDetailsContent');
    content.innerHTML = '<p class="loading-message">Loading...</p>';
    modal.style.display = 'block';

    try {
        const response = await fetch(`/api/flows/${flowId}`);
        const data = await response.json();

        if (data.success) {
            const flow = data.flow;
            document.getElementById('modalFlowName').textContent = flow.flow_name;

            content.innerHTML = `
                <div class="flow-details">
                    <h4>Flow Information</h4>
                    <p><strong>Flow ID:</strong> ${escapeHtml(flow.flow_name)}</p>
                    <p><strong>Server:</strong> ${escapeHtml(flow.server)}</p>
                    <p><strong>Priority:</strong> ${escapeHtml(flow.priority || 'N/A')}</p>
                    <p><strong>Owner:</strong> ${escapeHtml(flow.owner || 'N/A')}</p>
                    <p><strong>Description:</strong> ${escapeHtml(flow.description || 'N/A')}</p>
                    <p><strong>XML Path:</strong> ${escapeHtml(flow.nifi_xml_path || 'N/A')}</p>

                    <h4>Conversion Status</h4>
                    <p><strong>Status:</strong> ${getStatusBadge(flow.status)}</p>
                    <p><strong>Progress:</strong> ${flow.progress_percentage}%</p>
                    <p><strong>Message:</strong> ${escapeHtml(flow.status_message || 'N/A')}</p>
                    ${flow.error_message ? `<p class="error-message"><strong>Error:</strong> ${escapeHtml(flow.error_message)}</p>` : ''}
                    ${flow.databricks_run_id ?
                        `<p><strong>Databricks Run ID:</strong> ${escapeHtml(flow.databricks_run_id)}</p>` :
                        ''
                    }
                    ${flow.conversion_started_at ?
                        `<p><strong>Started:</strong> ${formatTimestamp(flow.conversion_started_at)}</p>` :
                        ''
                    }
                    ${flow.conversion_completed_at ?
                        `<p><strong>Completed:</strong> ${formatTimestamp(flow.conversion_completed_at)}</p>` :
                        ''
                    }

                    ${flow.generated_notebooks && flow.generated_notebooks.length > 0 ? `
                        <h4>Generated Notebooks</h4>
                        <ul>
                            ${flow.generated_notebooks.map(nb => `<li>${escapeHtml(nb)}</li>`).join('')}
                        </ul>
                        <button class="btn btn-primary" onclick="downloadNotebooks('${flow.flow_name}')">
                            Download Notebooks
                        </button>
                    ` : ''}

                    ${flow.total_attempts && flow.total_attempts > 0 ? `
                        <h4>Conversion History</h4>
                        <p><strong>Total Attempts:</strong> ${flow.total_attempts}</p>
                        <p><strong>Successful:</strong> ${flow.successful_conversions || 0}</p>
                        ${flow.first_attempt_at ? `<p><strong>First Attempt:</strong> ${formatTimestamp(flow.first_attempt_at)}</p>` : ''}
                        ${flow.last_attempt_at ? `<p><strong>Last Attempt:</strong> ${formatTimestamp(flow.last_attempt_at)}</p>` : ''}
                        <button class="btn btn-history" onclick="showFlowHistory('${flow.flow_name}')">
                            View All Attempts (${flow.total_attempts})
                        </button>
                        <div id="historyContainer"></div>
                    ` : ''}
                </div>
            `;
        } else {
            content.innerHTML = `<p class="error-message">${escapeHtml(data.error)}</p>`;
        }
    } catch (error) {
        content.innerHTML = `<p class="error-message">Error: ${escapeHtml(error.message)}</p>`;
    }
}

function closeFlowDetails() {
    document.getElementById('flowDetailsModal').style.display = 'none';
}

function downloadNotebooks(flowId) {
    window.location.href = `/api/flows/${flowId}/download`;
}

async function showFlowHistory(flowId) {
    const container = document.getElementById('historyContainer');
    container.innerHTML = '<p class="loading-message">Loading history...</p>';

    try {
        const response = await fetch(`/api/flows/${flowId}/history?limit=20`);
        const data = await response.json();

        if (data.success && data.history.length > 0) {
            const historyHtml = `
                <div class="history-section">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Attempt #</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Completed</th>
                                <th>Duration</th>
                                <th>Progress</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.history.map(attempt => {
                                const duration = attempt.duration_seconds
                                    ? `${Math.floor(attempt.duration_seconds / 60)}m ${attempt.duration_seconds % 60}s`
                                    : 'N/A';
                                return `
                                    <tr>
                                        <td>#${attempt.attempt_number}</td>
                                        <td>${getStatusBadge(attempt.status)}</td>
                                        <td>${formatTimestamp(attempt.started_at)}</td>
                                        <td>${attempt.completed_at ? formatTimestamp(attempt.completed_at) : 'In Progress'}</td>
                                        <td>${duration}</td>
                                        <td>${attempt.progress_percentage || 0}%</td>
                                        <td>${attempt.error_message ? escapeHtml(attempt.error_message.substring(0, 50)) : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = historyHtml;
        } else {
            container.innerHTML = '<p class="info-message">No conversion history available.</p>';
        }
    } catch (error) {
        container.innerHTML = `<p class="error-message">Failed to load history: ${escapeHtml(error.message)}</p>`;
    }
}

function filterFlows() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('.flow-row');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        // Only refresh if there are converting flows
        const hasConverting = flows.some(f => f.status === 'CONVERTING');
        if (hasConverting) {
            loadFlows();
        }
    }, 5000); // Refresh every 5 seconds
}

function showSuccess(message) {
    // Simple alert for now - could be replaced with a toast notification
    alert(message);
}

function showError(message) {
    // Simple alert for now - could be replaced with a toast notification
    alert('Error: ' + message);
}

// Close modal on outside click
window.onclick = function(event) {
    const modal = document.getElementById('flowDetailsModal');
    if (event.target === modal) {
        closeFlowDetails();
    }
}
</script>
{% endblock %}
